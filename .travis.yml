language: c
addons:
  artifacts:
    working_dir:
      - $TRAVIS_BUILD_DIR/artifacts

matrix:
  include:
    - name: "haxm-darwin"
      os: osx
      osx_image: xcode10
      addons:
        homebrew:
          packages:
            - nasm
      script:
        - cd platforms/darwin
        - xcodebuild -configuration Debug -sdk macosx10.14
      after_success:
        - export ARTIFACTS_SUBFOLDER=$TRAVIS_BUILD_DIR/artifacts/$TRAVIS_JOB_NAME
        - mkdir -p $ARTIFACTS_SUBFOLDER
        - cp -R ./build/Debug $ARTIFACTS_SUBFOLDER

    - name: "haxm-linux"
      os: linux
      dist: trusty
      sudo: false
      install:
        - sudo apt-get update
        - sudo apt-get install -y linux-headers-`uname -r`
        - wget http://mirrors.kernel.org/ubuntu/pool/universe/n/nasm/nasm_2.13.02-0.1_amd64.deb
        - sudo apt-get install -y dpkg
        - sudo dpkg -i nasm_2.13.02-0.1_amd64.deb
      script:
        - cd platforms/linux
        - make -j$(nproc)
      after_success:
        - export ARTIFACTS_SUBFOLDER=$TRAVIS_BUILD_DIR/artifacts/$TRAVIS_JOB_NAME
        - mkdir -p $ARTIFACTS_SUBFOLDER
        - cp haxm.ko $ARTIFACTS_SUBFOLDER

  exclude:
    - name: "haxm-windows"
      os: windows
      install:
        - choco install -y nuget.commandline
        - choco install -y windowsdriverkit10 --version 10.0.17763
        - choco install -y windows-sdk-10.1 --version 10.1.17763.1
      script:
        - cd platforms/windows
        - nuget restore
        - export PATH="$PATH:/c/Program Files (x86)/Microsoft Visual Studio/Installer/"
        - export MSVC=$(vswhere -latest -products "*" -requires Microsoft.Component.MSBuild -property installationPath)
        - export MSVC=$(echo /$MSVC | sed -e 's/\\/\//g' -e 's/://')
        - export PATH="$PATH:$MSVC/MSBuild/15.0/Bin/"
        # TODO: Remove the following hack when no longer needed.
        # NOTE: Officially WDK does not support VS Build Tools, only regular VS/EWDK installations,
        #       but since those are not supported by TravisCI, we need to install targets manually.
        - unzip "/c/Program Files (x86)/Windows Kits/10/Vsix/WDK.vsix" -d wdk
        - cp -R wdk/\$VCTargets/* "$MSVC/Common7/IDE/VC/VCTargets"
        - export PROPS="//p:DefaultWindowsSDKVersion=10.0.17763.0 //p:SpectreMitigation=false"
        - MSBuild.exe haxm.sln $PROPS //p:Configuration="Debug" //p:Platform="Win32"
        - MSBuild.exe haxm.sln $PROPS //p:Configuration="Debug" //p:Platform="x64"
        - build/tests/x64/Debug/haxm-tests.exe
      after_success:
        - export ARTIFACTS_SUBFOLDER=$TRAVIS_BUILD_DIR/artifacts/$TRAVIS_JOB_NAME
        - mkdir -p $ARTIFACTS_SUBFOLDER
        - cp -R ./build/out $ARTIFACTS_SUBFOLDER
